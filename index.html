<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PDF Toolkit</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-element@0.378.0/dist/lucide-element.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; } /* slate-200 */
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; } /* slate-400 */
        ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* slate-500 */

        /* Tool selection active state */
        .tool-btn.active {
            background-color: #eef2ff; /* indigo-50 */
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }

        /* File input area styling */
        .drop-zone {
            border: 2px dashed #cbd5e1; /* slate-300 */
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .drop-zone.dragover {
            background-color: #eef2ff; /* indigo-50 */
            border-color: #6366f1; /* indigo-500 */
        }

        /* Custom checkbox and toggle styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        
        /* Spinner animation */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border-left-color: #4f46e5; /* indigo-600 */
            animation: spin 1s ease-in-out infinite;
        }
        
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="flex h-screen bg-slate-50">
        <!-- Sidebar for Tools -->
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col">
            <div class="p-6 border-b border-slate-200">
                <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                    <lucide-icon name="file-cog" class="text-indigo-600"></lucide-icon>
                    PDF Toolkit
                </h1>
            </div>
            <nav id="tool-list" class="flex-grow p-4 space-y-2">
                <button data-tool="protect" class="tool-btn w-full flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 active">
                    <lucide-icon name="lock"></lucide-icon> Protect PDF
                </button>
                <button data-tool="merge" class="tool-btn w-full flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100">
                    <lucide-icon name="merge"></lucide-icon> Merge PDFs
                </button>
                <button data-tool="split" class="tool-btn w-full flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100">
                    <lucide-icon name="file-symlink"></lucide-icon> Split PDF
                </button>
                <button data-tool="rotate" class="tool-btn w-full flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100">
                    <lucide-icon name="rotate-cw"></lucide-icon> Rotate Pages
                </button>
            </nav>
            <div class="p-4 text-xs text-center text-slate-400">
                <p>All processing is done securely in your browser.</p>
                <p>&copy; 2024 Advanced PDF Toolkit</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center">
                <h2 id="tool-title" class="text-xl font-semibold text-slate-700">Protect PDF</h2>
                <button id="process-btn" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-2">
                    <lucide-icon name="play"></lucide-icon>
                    <span id="process-btn-text">Protect PDF</span>
                </button>
            </header>

            <!-- Workspace -->
            <div class="flex-1 flex overflow-hidden">
                <!-- File Upload & List Panel -->
                <div class="w-1/3 bg-white border-r border-slate-200 flex flex-col overflow-y-auto">
                    <div class="p-4">
                        <label for="file-input" class="drop-zone w-full p-6 rounded-lg text-center cursor-pointer block bg-slate-50 hover:bg-slate-100">
                            <lucide-icon name="upload-cloud" class="mx-auto h-12 w-12 text-slate-400"></lucide-icon>
                            <p class="mt-2 text-sm text-slate-600">
                                <span class="font-semibold text-indigo-600">Click to upload</span> or drag and drop
                            </p>
                            <p class="text-xs text-slate-500 mt-1">Select PDF files to begin</p>
                        </label>
                        <input type="file" id="file-input" accept=".pdf" multiple class="hidden">
                    </div>
                    <div id="file-list" class="flex-grow p-4 space-y-3">
                        <!-- File items will be injected here -->
                    </div>
                </div>

                <!-- Tool Options Panel -->
                <div class="flex-1 p-8 overflow-y-auto">
                    <!-- Protect Options -->
                    <div id="protect-options" class="tool-options-panel space-y-6">
                        <h3 class="text-lg font-semibold border-b pb-2">Password Settings</h3>
                        <div>
                            <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                            <input type="password" id="password" placeholder="Enter a strong password" class="w-full px-4 py-2 text-slate-800 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                        <h3 class="text-lg font-semibold border-b pb-2 mt-6">Permissions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center justify-between p-3 bg-slate-100 rounded-lg">
                                <span class="text-sm font-medium">Allow Printing</span>
                                <input type="checkbox" data-permission="printing" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300">
                            </label>
                            <label class="flex items-center justify-between p-3 bg-slate-100 rounded-lg">
                                <span class="text-sm font-medium">Allow Copying</span>
                                <input type="checkbox" data-permission="copying" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300">
                            </label>
                            <label class="flex items-center justify-between p-3 bg-slate-100 rounded-lg">
                                <span class="text-sm font-medium">Allow Modifying</span>
                                <input type="checkbox" data-permission="modifying" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300">
                            </label>
                            <label class="flex items-center justify-between p-3 bg-slate-100 rounded-lg">
                                <span class="text-sm font-medium">Allow Annotating</span>
                                <input type="checkbox" data-permission="annotating" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300">
                            </label>
                        </div>
                    </div>

                    <!-- Merge Options -->
                    <div id="merge-options" class="tool-options-panel hidden">
                        <h3 class="text-lg font-semibold border-b pb-2">Merge PDFs</h3>
                        <p class="text-slate-600 mt-4">All uploaded files will be merged into a single PDF in the order they appear in the file list. Drag and drop files in the list to reorder them.</p>
                        <p class="mt-4 p-4 bg-indigo-50 text-indigo-800 rounded-lg text-sm">
                            <lucide-icon name="info" class="inline-block mr-2 h-4 w-4"></lucide-icon>
                            At least two files are required to perform a merge.
                        </p>
                    </div>

                    <!-- Split Options -->
                    <div id="split-options" class="tool-options-panel hidden space-y-6">
                        <h3 class="text-lg font-semibold border-b pb-2">Split PDF</h3>
                        <p class="text-slate-600">This tool works with the <span class="font-bold">first</span> uploaded file only.</p>
                        <div>
                            <label for="split-range" class="block text-sm font-medium text-slate-700 mb-1">Page Ranges</label>
                            <input type="text" id="split-range" placeholder="e.g., 1-5, 8, 10-12" class="w-full px-4 py-2 text-slate-800 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                            <p class="text-xs text-slate-500 mt-1">Enter page numbers or ranges separated by commas. The tool will create a new PDF for each range.</p>
                        </div>
                    </div>

                    <!-- Rotate Options -->
                    <div id="rotate-options" class="tool-options-panel hidden space-y-6">
                        <h3 class="text-lg font-semibold border-b pb-2">Rotate Pages</h3>
                        <p class="text-slate-600">This tool works with the <span class="font-bold">first</span> uploaded file only.</p>
                        <div>
                            <label for="rotate-degrees" class="block text-sm font-medium text-slate-700 mb-1">Rotation Angle</label>
                            <select id="rotate-degrees" class="w-full px-4 py-2 text-slate-800 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                                <option value="90">90째 Clockwise</option>
                                <option value="180">180째</option>
                                <option value="270">270째 Clockwise (90째 Counter-clockwise)</option>
                            </select>
                        </div>
                         <div>
                            <label for="rotate-pages" class="block text-sm font-medium text-slate-700 mb-1">Pages to Rotate</label>
                            <input type="text" id="rotate-pages" placeholder="e.g., 1-5, 8, 10-12 (or leave blank for all)" class="w-full px-4 py-2 text-slate-800 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                            <p class="text-xs text-slate-500 mt-1">Enter page numbers or ranges. Leave blank to rotate all pages.</p>
                        </div>
                    </div>
                    
                     <!-- Placeholder for when no files are uploaded -->
                    <div id="no-files-placeholder" class="text-center py-20">
                        <lucide-icon name="file-x-2" class="mx-auto h-24 w-24 text-slate-300"></lucide-icon>
                        <h3 class="mt-4 text-lg font-semibold text-slate-600">No Options Available</h3>
                        <p class="mt-1 text-sm text-slate-500">Please upload a PDF file to see the available options for the selected tool.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Processing Modal -->
    <div id="processing-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-8 text-center shadow-xl">
            <div class="spinner mx-auto"></div>
            <p id="processing-message" class="mt-4 text-lg font-semibold text-slate-700">Processing...</p>
        </div>
    </div>
    
    <!-- File Item Template -->
    <template id="file-item-template">
        <div class="file-item flex items-center p-2 bg-slate-50 rounded-lg border border-slate-200 shadow-sm">
            <canvas class="file-preview w-10 h-14 bg-white border border-slate-200 rounded"></canvas>
            <div class="flex-grow ml-3 overflow-hidden">
                <p class="file-name text-sm font-medium text-slate-800 truncate">file_name.pdf</p>
                <p class="file-info text-xs text-slate-500">0 pages</p>
            </div>
            <button class="remove-file-btn p-1 text-slate-400 hover:text-red-500 rounded-full hover:bg-red-100">
                <lucide-icon name="x" class="h-4 w-4"></lucide-icon>
            </button>
        </div>
    </template>

    <script>
        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        const { PDFDocument, rgb, degrees, PageSizes } = PDFLib;

        // --- STATE MANAGEMENT ---
        const AppState = {
            activeTool: 'protect',
            files: [], // { id, name, arrayBuffer, pdfDoc, pageCount }
            isProcessing: false,
        };

        // --- DOM ELEMENT REFERENCES ---
        const DOMElements = {
            toolList: document.getElementById('tool-list'),
            toolTitle: document.getElementById('tool-title'),
            processBtn: document.getElementById('process-btn'),
            processBtnText: document.getElementById('process-btn-text'),
            dropZone: document.querySelector('.drop-zone'),
            fileInput: document.getElementById('file-input'),
            fileList: document.getElementById('file-list'),
            fileItemTemplate: document.getElementById('file-item-template'),
            processingModal: document.getElementById('processing-modal'),
            processingMessage: document.getElementById('processing-message'),
            noFilesPlaceholder: document.getElementById('no-files-placeholder'),
            optionPanels: document.querySelectorAll('.tool-options-panel'),
            // Input fields
            passwordInput: document.getElementById('password'),
            permissionCheckboxes: document.querySelectorAll('#protect-options input[type="checkbox"]'),
            splitRangeInput: document.getElementById('split-range'),
            rotateDegreesInput: document.getElementById('rotate-degrees'),
            rotatePagesInput: document.getElementById('rotate-pages'),
        };

        // --- UI LOGIC ---
        const UI = {
            init() {
                DOMElements.toolList.addEventListener('click', this.handleToolSwitch);
                DOMElements.fileInput.addEventListener('change', this.handleFileSelect);
                DOMElements.fileList.addEventListener('click', this.handleFileRemove);
                DOMElements.processBtn.addEventListener('click', handleProcessRequest);
                
                // Drag and drop functionality
                const dz = DOMElements.dropZone;
                dz.addEventListener('dragover', e => {
                    e.preventDefault();
                    dz.classList.add('dragover');
                });
                dz.addEventListener('dragleave', e => {
                    e.preventDefault();
                    dz.classList.remove('dragover');
                });
                dz.addEventListener('drop', e => {
                    e.preventDefault();
                    dz.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        DOMElements.fileInput.files = e.dataTransfer.files;
                        this.handleFileSelect();
                    }
                });
            },
            handleToolSwitch(e) {
                const button = e.target.closest('.tool-btn');
                if (!button || button.dataset.tool === AppState.activeTool) return;
                
                AppState.activeTool = button.dataset.tool;
                
                // Update button styles
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Update header and panels
                const toolName = button.innerText.trim();
                DOMElements.toolTitle.innerText = toolName;
                DOMElements.processBtnText.innerText = toolName;
                
                DOMElements.optionPanels.forEach(panel => panel.classList.add('hidden'));
                document.getElementById(`${AppState.activeTool}-options`).classList.remove('hidden');
                
                UI.updateUIState();
            },
            async handleFileSelect() {
                const newFiles = Array.from(DOMElements.fileInput.files);
                if (newFiles.length === 0) return;

                UI.showProcessingModal('Loading files...');
                for (const file of newFiles) {
                    if (file.type !== 'application/pdf') continue;
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
                    AppState.files.push({
                        id: `file-${Date.now()}-${Math.random()}`,
                        name: file.name,
                        arrayBuffer,
                        pdfDoc,
                        pageCount: pdfDoc.getPageCount()
                    });
                }
                this.renderFileList();
                UI.updateUIState();
                UI.hideProcessingModal();
            },
            handleFileRemove(e) {
                const button = e.target.closest('.remove-file-btn');
                if (!button) return;
                const fileItem = button.closest('.file-item');
                const fileId = fileItem.dataset.id;
                
                AppState.files = AppState.files.filter(f => f.id !== fileId);
                fileItem.remove();
                UI.updateUIState();
            },
            renderFileList() {
                DOMElements.fileList.innerHTML = '';
                AppState.files.forEach(file => {
                    const item = DOMElements.fileItemTemplate.content.cloneNode(true);
                    const fileItemDiv = item.querySelector('.file-item');
                    fileItemDiv.dataset.id = file.id;
                    item.querySelector('.file-name').textContent = file.name;
                    item.querySelector('.file-info').textContent = `${file.pageCount} pages`;
                    DOMElements.fileList.appendChild(item);
                    this.renderFilePreview(file.pdfDoc, fileItemDiv.querySelector('.file-preview'));
                });
            },
            async renderFilePreview(pdfDoc, canvas) {
                try {
                    const page = pdfDoc.getPage(0);
                    const viewport = page.getViewport({ scale: 0.2 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const context = canvas.getContext('2d');
                    
                    // To render with pdf.js, we need to get the raw bytes again
                    const pdfBytes = await pdfDoc.save();
                    const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    const pdfJsPage = await pdfJsDoc.getPage(1);
                    const pdfJsViewport = pdfJsPage.getViewport({ scale: canvas.width / pdfJsPage.getViewport({scale:1}).width });
                    
                    canvas.height = pdfJsViewport.height;
                    canvas.width = pdfJsViewport.width;
                    
                    await pdfJsPage.render({ canvasContext: context, viewport: pdfJsViewport }).promise;
                } catch (error) {
                    console.error("Preview rendering failed:", error);
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#fde047'; // yellow-300
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#78350f'; // yellow-900
                    ctx.font = '10px sans-serif';
                    ctx.fillText('Preview', 4, 12);
                    ctx.fillText('Error', 6, 24);
                }
            },
            updateUIState() {
                const hasFiles = AppState.files.length > 0;
                DOMElements.noFilesPlaceholder.classList.toggle('hidden', hasFiles);
                DOMElements.optionPanels.forEach(p => p.classList.toggle('hidden', !hasFiles));
                
                if (hasFiles) {
                    document.getElementById(`${AppState.activeTool}-options`).classList.remove('hidden');
                }

                // Tool specific logic
                let isProcessable = false;
                if (hasFiles) {
                    switch(AppState.activeTool) {
                        case 'protect':
                        case 'split':
                        case 'rotate':
                            isProcessable = true;
                            break;
                        case 'merge':
                            isProcessable = AppState.files.length >= 2;
                            break;
                    }
                }
                DOMElements.processBtn.disabled = !isProcessable;
            },
            showProcessingModal(message = 'Processing...') {
                DOMElements.processingMessage.textContent = message;
                DOMElements.processingModal.classList.remove('hidden');
            },
            hideProcessingModal() {
                DOMElements.processingModal.classList.add('hidden');
            }
        };

        // --- PDF PROCESSING LOGIC ---
        const PDFTools = {
            async protect() {
                if (AppState.files.length === 0) throw new Error("No file to protect.");
                const file = AppState.files[0];
                const password = DOMElements.passwordInput.value;
                if (!password) throw new Error("Password is required.");

                const options = { userPassword: password, ownerPassword: password, permissions: {} };
                DOMElements.permissionCheckboxes.forEach(cb => {
                    options.permissions[cb.dataset.permission] = cb.checked;
                });

                const pdfBytes = await file.pdfDoc.save({ encrypt: options });
                Utils.download(pdfBytes, `${Utils.getFileName(file.name)}-protected.pdf`);
            },
            async merge() {
                if (AppState.files.length < 2) throw new Error("At least two files are required to merge.");
                const mergedPdf = await PDFDocument.create();
                for (const file of AppState.files) {
                    const copiedPages = await mergedPdf.copyPages(file.pdfDoc, file.pdfDoc.getPageIndices());
                    copiedPages.forEach(page => mergedPdf.addPage(page));
                }
                const pdfBytes = await mergedPdf.save();
                Utils.download(pdfBytes, 'merged-document.pdf');
            },
            async split() {
                if (AppState.files.length === 0) throw new Error("No file to split.");
                const file = AppState.files[0];
                const ranges = Utils.parsePageRanges(DOMElements.splitRangeInput.value, file.pageCount);
                if (ranges.length === 0) throw new Error("Invalid or no page ranges provided.");
                
                // For simplicity, we'll handle one range at a time. A real app might zip multiple outputs.
                const range = ranges[0];
                const newPdf = await PDFDocument.create();
                const pageIndices = range.map(p => p - 1); // to 0-based index
                const copiedPages = await newPdf.copyPages(file.pdfDoc, pageIndices);
                copiedPages.forEach(page => newPdf.addPage(page));
                
                const pdfBytes = await newPdf.save();
                Utils.download(pdfBytes, `${Utils.getFileName(file.name)}-split-p${range[0]}-${range[range.length-1]}.pdf`);
            },
            async rotate() {
                if (AppState.files.length === 0) throw new Error("No file to rotate.");
                const file = AppState.files[0];
                const angle = parseInt(DOMElements.rotateDegreesInput.value, 10);
                const pageRangesStr = DOMElements.rotatePagesInput.value;
                
                const pagesToRotate = pageRangesStr 
                    ? Utils.parsePageRanges(pageRangesStr, file.pageCount).flat()
                    : file.pdfDoc.getPageIndices().map(i => i + 1);
                
                if (pagesToRotate.length === 0) throw new Error("Invalid or no pages specified for rotation.");

                pagesToRotate.forEach(pageNum => {
                    const page = file.pdfDoc.getPage(pageNum - 1);
                    const currentRotation = page.getRotation().angle;
                    page.setRotation(degrees(currentRotation + angle));
                });
                
                const pdfBytes = await file.pdfDoc.save();
                Utils.download(pdfBytes, `${Utils.getFileName(file.name)}-rotated.pdf`);
            }
        };
        
        // --- UTILITY FUNCTIONS ---
        const Utils = {
            download(bytes, name) {
                const blob = new Blob([bytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            },
            getFileName(fullName) {
                return fullName.substring(0, fullName.lastIndexOf('.')) || fullName;
            },
            parsePageRanges(str, maxPage) {
                if (!str.trim()) return [];
                const ranges = [];
                const parts = str.split(',');
                for (const part of parts) {
                    const trimmedPart = part.trim();
                    if (trimmedPart.includes('-')) {
                        const [start, end] = trimmedPart.split('-').map(p => parseInt(p.trim(), 10));
                        if (!isNaN(start) && !isNaN(end) && start <= end && start > 0 && end <= maxPage) {
                            const range = [];
                            for (let i = start; i <= end; i++) range.push(i);
                            ranges.push(range);
                        }
                    } else {
                        const page = parseInt(trimmedPart, 10);
                        if (!isNaN(page) && page > 0 && page <= maxPage) {
                            ranges.push([page]);
                        }
                    }
                }
                return ranges;
            }
        };
        
        // --- MAIN EVENT HANDLER ---
        async function handleProcessRequest() {
            if (AppState.isProcessing) return;
            AppState.isProcessing = true;
            UI.showProcessingModal(`Running ${DOMElements.toolTitle.innerText}...`);
            
            try {
                const toolFunction = PDFTools[AppState.activeTool];
                if (toolFunction) {
                    await toolFunction();
                } else {
                    throw new Error("Selected tool is not implemented.");
                }
            } catch (error) {
                console.error(error);
                alert(`An error occurred: ${error.message}`);
            } finally {
                AppState.isProcessing = false;
                UI.hideProcessingModal();
            }
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
            UI.updateUIState();
        });
    </script>
</body>
</html>
