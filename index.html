<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered PDF Protector</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf-lib: A library to create and modify PDF documents in any JavaScript environment. -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- pdf.js: A library to render PDF files in the browser. Needed for the AI analysis feature. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|sparkles" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-label {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-input-label:hover {
            background-color: #f0f4ff;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease-in-out infinite;
        }
        .gemini-btn {
            background: linear-gradient(90deg, #4f46e5, #818cf8);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-xl shadow-lg p-8 md:p-10">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 flex items-center justify-center gap-2">
                <i class="gg-sparkles text-indigo-500"></i> AI PDF Protector
            </h1>
            <p class="text-gray-500 mt-2">Add a password to your PDF files securely in your browser.</p>
            <p class="text-sm text-blue-600 mt-1">Your files are never uploaded to any server.</p>
        </div>

        <div id="upload-form">
            <div class="mb-6">
                <label for="pdf-file" class="block text-sm font-medium text-gray-700 mb-2">1. Choose a PDF file</label>
                <label for="pdf-file" class="file-input-label flex justify-center w-full h-32 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-md appearance-none">
                    <span class="flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span id="file-name" class="font-medium text-gray-600">
                            Drop files to Attach, or <span class="text-blue-600 underline">browse</span>
                        </span>
                    </span>
                    <input type="file" id="pdf-file" accept=".pdf" class="hidden">
                </label>
            </div>

            <!-- AI Analysis Section -->
            <div id="ai-section" class="hidden mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                 <button id="analyze-btn" class="w-full gemini-btn text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100 flex items-center justify-center gap-2">
                    <i class="gg-sparkles"></i>
                    <span>Analyze & Suggest Title</span>
                </button>
                <div id="ai-spinner" class="spinner mx-auto my-4 hidden"></div>
                <div id="ai-results" class="hidden mt-4 text-sm">
                    <p class="font-semibold text-gray-800">Summary:</p>
                    <p id="ai-summary" class="text-gray-600 mb-2"></p>
                    <p class="font-semibold text-gray-800">Suggested Filename:</p>
                    <p id="ai-filename" class="text-blue-600 font-mono cursor-pointer hover:underline"></p>
                </div>
            </div>

            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-2">2. Set a Password</label>
                <input type="password" id="password" placeholder="Enter your desired password" class="w-full px-4 py-3 text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <div>
                <button id="protect-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100">
                    Protect PDF
                </button>
            </div>
        </div>

        <div id="status-section" class="text-center hidden">
            <div id="spinner" class="spinner mx-auto my-4 hidden"></div>
            <p id="status-message" class="text-lg font-medium text-gray-700"></p>
            <a id="download-link" class="mt-6 inline-block w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 hidden">
                Download Protected PDF
            </a>
             <button id="reset-btn" class="mt-4 w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition hidden">
                Protect Another File
            </button>
        </div>
        
        <div id="error-box" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
            <p id="error-message"></p>
        </div>
        
        <!-- Hidden canvas for rendering PDF page -->
        <canvas id="pdf-canvas" class="hidden"></canvas>
    </div>

    <script>
        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        // DOM Elements
        const uploadForm = document.getElementById('upload-form');
        const pdfFileInput = document.getElementById('pdf-file');
        const passwordInput = document.getElementById('password');
        const protectBtn = document.getElementById('protect-btn');
        const fileNameDisplay = document.getElementById('file-name');
        
        const statusSection = document.getElementById('status-section');
        const spinner = document.getElementById('spinner');
        const statusMessage = document.getElementById('status-message');
        const downloadLink = document.getElementById('download-link');
        const resetBtn = document.getElementById('reset-btn');
        
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');

        const aiSection = document.getElementById('ai-section');
        const analyzeBtn = document.getElementById('analyze-btn');
        const aiSpinner = document.getElementById('ai-spinner');
        const aiResults = document.getElementById('ai-results');
        const aiSummary = document.getElementById('ai-summary');
        const aiFilename = document.getElementById('ai-filename');
        const pdfCanvas = document.getElementById('pdf-canvas');

        // State variables
        let originalFileName = '';
        let suggestedFileName = '';

        // Event Listeners
        pdfFileInput.addEventListener('change', handleFileSelect);
        protectBtn.addEventListener('click', handleProtectClick);
        analyzeBtn.addEventListener('click', handleAnalyzeClick);
        resetBtn.addEventListener('click', resetUI);
        aiFilename.addEventListener('click', () => {
            if (suggestedFileName) {
                originalFileName = suggestedFileName + '.pdf';
                fileNameDisplay.textContent = `Using: ${originalFileName}`;
                fileNameDisplay.classList.add('text-indigo-600');
            }
        });

        function handleFileSelect() {
            if (pdfFileInput.files.length > 0) {
                originalFileName = pdfFileInput.files[0].name;
                const displayName = originalFileName.replace(/\.pdf$/i, '');
                fileNameDisplay.textContent = `File: ${displayName}`;
                fileNameDisplay.classList.add('text-green-600');
                aiSection.classList.remove('hidden');
                aiResults.classList.add('hidden');
                analyzeBtn.disabled = false;
            } else {
                fileNameDisplay.textContent = 'Drop files to Attach, or browse';
                fileNameDisplay.classList.remove('text-green-600');
                aiSection.classList.add('hidden');
            }
        }

        async function handleAnalyzeClick() {
            const file = pdfFileInput.files[0];
            if (!file) {
                showError("Please select a file first.");
                return;
            }

            analyzeBtn.disabled = true;
            aiSpinner.classList.remove('hidden');
            aiResults.classList.add('hidden');
            errorBox.classList.add('hidden');

            try {
                // 1. Render PDF page to canvas
                const fileReader = new FileReader();
                fileReader.onload = async (event) => {
                    const typedarray = new Uint8Array(event.target.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    const page = await pdf.getPage(1); // Get first page
                    const viewport = page.getViewport({ scale: 1.5 });
                    const context = pdfCanvas.getContext('2d');
                    pdfCanvas.height = viewport.height;
                    pdfCanvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    // 2. Get image data from canvas
                    const base64ImageData = pdfCanvas.toDataURL('image/png').split(',')[1];
                    
                    // 3. Call Gemini API
                    const response = await callGeminiForPdfAnalysis(base64ImageData);
                    
                    aiSummary.textContent = response.summary;
                    aiFilename.textContent = response.filename;
                    suggestedFileName = response.filename; // Store for later use
                    
                    aiResults.classList.remove('hidden');
                };
                fileReader.readAsArrayBuffer(file);

            } catch (err) {
                console.error("Analysis Error:", err);
                showError("Could not analyze the PDF. It might be empty, corrupted, or password-protected already.");
            } finally {
                aiSpinner.classList.add('hidden');
                 // Keep button disabled after one analysis
            }
        }
        
        async function callGeminiForPdfAnalysis(base64ImageData) {
            const apiKey = ""; // API key will be injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const prompt = `Analyze the content of this document page. Provide a one-sentence summary and suggest a descriptive, URL-friendly filename (kebab-case, no extension). Format your response as a valid JSON object with two keys: "summary" and "filename". Example: {"summary": "A weekly project status report for the Phoenix project.", "filename": "phoenix-project-status-report-week-10"}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/png", data: base64ImageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            
            let response;
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates[0].content.parts[0].text;
                        return JSON.parse(text);
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; // Exponential backoff
                }
            }
            
            throw new Error("Failed to get a response from the AI model after several retries.");
        }


        async function handleProtectClick() {
            const file = pdfFileInput.files[0];
            const password = passwordInput.value;

            errorBox.classList.add('hidden');

            if (!file) {
                showError('Please select a PDF file first.');
                return;
            }
            if (!password) {
                showError('Please enter a password.');
                return;
            }

            protectBtn.disabled = true;
            passwordInput.disabled = true;
            pdfFileInput.disabled = true;
            
            uploadForm.classList.add('hidden');
            statusSection.classList.remove('hidden');
            spinner.classList.remove('hidden');
            statusMessage.textContent = 'Reading your PDF file...';

            try {
                const { PDFDocument } = PDFLib;
                const existingPdfBytes = await file.arrayBuffer();
                statusMessage.textContent = 'Loading document...';
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                statusMessage.textContent = 'Applying password protection...';
                
                const encryptionOptions = {
                    userPassword: password,
                    ownerPassword: password,
                    permissions: { printing: 'highResolution', modifying: false, copying: false, annotating: false, fillingForms: false, contentAccessibility: false, documentAssembly: false },
                };

                const pdfBytes = await pdfDoc.save({ encrypt: encryptionOptions });
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const downloadUrl = URL.createObjectURL(blob);

                downloadLink.href = downloadUrl;
                const protectedFileName = originalFileName.replace(/\.pdf$/i, '') + '-protected.pdf';
                downloadLink.download = protectedFileName;

                spinner.classList.add('hidden');
                statusMessage.textContent = 'Success! Your PDF is protected.';
                downloadLink.classList.remove('hidden');
                resetBtn.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                showError('An error occurred while processing the PDF. The file might be corrupted or in an unsupported format.');
                resetUI();
            }
        }
        
        function resetUI() {
            pdfFileInput.value = '';
            passwordInput.value = '';
            originalFileName = '';
            suggestedFileName = '';
            
            protectBtn.disabled = false;
            passwordInput.disabled = false;
            pdfFileInput.disabled = false;
            analyzeBtn.disabled = false;
            
            fileNameDisplay.textContent = 'Drop files to Attach, or browse';
            fileNameDisplay.classList.remove('text-green-600', 'text-indigo-600');

            statusSection.classList.add('hidden');
            downloadLink.classList.add('hidden');
            resetBtn.classList.add('hidden');
            uploadForm.classList.remove('hidden');
            aiSection.classList.add('hidden');
            aiResults.classList.add('hidden');
            
            errorBox.classList.add('hidden');
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            // Also hide main spinner if an error occurs during processing
            spinner.classList.add('hidden');
            statusSection.classList.add('hidden');
            uploadForm.classList.remove('hidden');
        }

    </script>
</body>
</html>
